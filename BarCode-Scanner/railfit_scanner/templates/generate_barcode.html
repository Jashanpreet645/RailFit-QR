<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Generator - RailFit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>Barcode Generator</h1>
        <nav>
            <a href="/" class="nav-link">Scanner</a>
            <a href="/generate" class="nav-link active">Generate</a>
        </nav>
    </header>
    
    <main class="container">
        <section class="generator-section">
            <h2>Generate Custom Barcode</h2>
            <form id="generate-form">
                <div class="input-group">
                    <label for="barcode-input">Enter 23-digit code:</label>
                    <input type="text" id="barcode-input" maxlength="23" 
                           placeholder="e.g., 1XXXXXXXXXX9XXXXXXXXXX1"
                           pattern="^1[0-9]{10}9[0-9]{10}1$"
                           title="Must be 23 digits, starting and ending with 1, and have 9 at position 12">
                    <small>Format: First and last digits must be 1, 12th digit must be 9</small>
                </div>
                <button type="submit" class="btn-primary">Generate Barcode</button>
            </form>
            
            <div id="barcode-result" class="barcode-container" style="display: none;">
                <h3>Generated Barcode:</h3>
                <div id="barcode-preview"></div>
                <div class="barcode-info">
                    <div id="barcode-value" class="barcode-value"></div>
                    <div class="barcode-actions">
                        <button id="download-barcode" class="btn-secondary">
                            <span class="icon">‚¨áÔ∏è</span> Download
                        </button>
                        <button id="copy-barcode" class="btn-secondary">
                            <span class="icon">üìã</span> Copy Image
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="instructions">
            <h3>How to Use</h3>
            <ol>
                <li>Enter a 23-digit code where:
                    <ul>
                        <li>First and last digits must be 1</li>
                        <li>12th digit must be 9</li>
                        <li>All other digits can be 0-9</li>
                    </ul>
                </li>
                <li>Click "Generate Barcode" to create your custom barcode</li>
                <li>Download or copy the generated barcode image</li>
            </ol>
        </section>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('generate-form');
            const barcodeInput = document.getElementById('barcode-input');
            const barcodeResult = document.getElementById('barcode-result');
            const barcodePreview = document.getElementById('barcode-preview');
            const barcodeValue = document.getElementById('barcode-value');
            const downloadBtn = document.getElementById('download-barcode');
            const copyBtn = document.getElementById('copy-barcode');
            
            // Form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const code = barcodeInput.value.trim();
                
                // Validate input
                if (code.length !== 23 || !/^\d+$/.test(code)) {
                    showError('Please enter exactly 23 digits');
                    return;
                }
                
                if (code[0] !== '1' || code[11] !== '9' || code[22] !== '1') {
                    showError('Invalid format. First and last digits must be 1, and 12th digit must be 9');
                    return;
                }
                
                try {
                    // Show loading state
                    barcodePreview.innerHTML = '<div class="loading">Generating barcode...</div>';
                    
                    // Send request to generate barcode
                    const response = await fetch('/generate_barcode', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ digits: code })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Display generated barcode
                        barcodePreview.innerHTML = `<img src="${data.image}" alt="Generated Barcode">`;
                        barcodeValue.textContent = `Code: ${data.digits}`;
                        barcodeResult.style.display = 'block';
                        
                        // Scroll to result
                        barcodeResult.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        showError(data.error || 'Failed to generate barcode');
                    }
                } catch (error) {
                    showError('An error occurred while generating the barcode');
                    console.error('Error:', error);
                }
            });
            
            // Download barcode
            downloadBtn.addEventListener('click', function() {
                const img = barcodePreview.querySelector('img');
                if (img) {
                    const link = document.createElement('a');
                    link.download = `barcode_${barcodeInput.value}.png`;
                    link.href = img.src;
                    link.click();
                }
            });
            
            // Copy barcode to clipboard
            copyBtn.addEventListener('click', async function() {
                try {
                    const img = barcodePreview.querySelector('img');
                    if (img) {
                        // Fetch the image as a blob
                        const response = await fetch(img.src);
                        const blob = await response.blob();
                        
                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        
                        // Show success feedback
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<span class="icon">‚úì</span> Copied!';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error copying image:', error);
                    showError('Failed to copy image to clipboard');
                }
            });
            
            // Input validation
            barcodeInput.addEventListener('input', function() {
                // Only allow digits
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                
                // Remove any existing error messages
                const existingError = form.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }
                
                form.insertBefore(errorDiv, form.firstChild);
                
                // Scroll to error
                errorDiv.scrollIntoView({ behavior: 'smooth' });
            }
        });
    </script>
</body>
</html>
